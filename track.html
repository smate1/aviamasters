<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π - AVIAMASTERS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #333;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #00ff88, #00cc66);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-danger {
      background: #ff4757;
      color: white;
    }

    .btn-danger:hover {
      background: #ff3742;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #2ed573;
      color: white;
    }

    .btn-success:hover {
      background: #1dd1a1;
      transform: translateY(-2px);
    }

    .btn-info {
      background: #5352ed;
      color: white;
    }

    .btn-info:hover {
      background: #3742fa;
      transform: translateY(-2px);
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      font-weight: bold;
      color: #555;
    }

    .filter-group select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    .device-mobile {
      color: #ff6b6b;
    }

    .device-desktop {
      color: #4ecdc4;
    }

    .ip-cell {
      font-family: monospace;
      font-weight: bold;
      color: #333;
    }

    .country-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .country-flag {
      font-size: 1.2rem;
    }

    .time-cell {
      font-size: 0.9rem;
      color: #666;
    }

    .action-cell {
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f1f2f6;
      display: inline-block;
    }

    .action-visit {
      background: #3742fa;
      color: white;
    }

    .action-click {
      background: #2ed573;
      color: white;
    }

    .action-event {
      background: #ff6348;
      color: white;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .source-cell {
      max-width: 200px;
      word-wrap: break-word;
      font-size: 0.85rem;
      color: #666;
      line-height: 1.3;
    }

    .source-direct {
      color: #28a745;
      font-weight: bold;
    }

    .source-search {
      color: #007bff;
    }

    .source-social {
      color: #e83e8c;
    }

    .source-unknown {
      color: #6c757d;
      font-style: italic;
    }

    .export-info {
      margin-top: 20px;
      padding: 15px;
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid #3498db;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #555;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        justify-content: center;
      }

      table {
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 8px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π</h1>
      <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ AVIAMASTERS</p>
    </div>

    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-value" id="uniqueIPs">0</div>
        <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö IP</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalRecords">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="todayVisits">0</div>
        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uniqueCountries">0</div>
        <div class="stat-label">–°—Ç—Ä–∞–Ω</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalClicks">0</div>
        <div class="stat-label">–ö–ª–∏–∫–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uniqueSources">0</div>
        <div class="stat-label">–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-danger" onclick="clearLogs()">
        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
      </button>
      <button class="btn btn-success" onclick="downloadCSV()">
        üì• –°–∫–∞—á–∞—Ç—å CSV
      </button>
      <button class="btn btn-info" onclick="downloadJSON()">
        üìã –°–∫–∞—á–∞—Ç—å JSON
      </button>
      <button class="btn btn-info" onclick="refreshData()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>

      <div class="filter-group">
        <label for="countryFilter">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ:</label>
        <select id="countryFilter" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="typeFilter">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>
        <select id="typeFilter" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
          <option value="visit">–ü–æ—Å–µ—â–µ–Ω–∏—è</option>
          <option value="click">–ö–ª–∏–∫–∏</option>
          <option value="event">–°–æ–±—ã—Ç–∏—è</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="deviceFilter">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</label>
        <select id="deviceFilter" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
          <option value="Desktop">–î–µ—Å–∫—Ç–æ–ø</option>
          <option value="Mobile">–ú–æ–±–∏–ª—å–Ω—ã–π</option>
          <option value="Tablet">–ü–ª–∞–Ω—à–µ—Ç</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="uniqueFilter">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å:</label>
        <select id="uniqueFilter" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
          <option value="unique">–¢–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ IP</option>
          <option value="repeat">–¢–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ IP</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="sourceFilter">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
        <select id="sourceFilter" onchange="filterTable()">
          <option value="">–í—Å–µ</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table id="logTable">
        <thead>
          <tr>
            <th>IP</th>
            <th>–°—Ç—Ä–∞–Ω–∞</th>
            <th>–ì–æ—Ä–æ–¥</th>
            <th>–í—Ä–µ–º—è</th>
            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
            <th>–ë—Ä–∞—É–∑–µ—Ä</th>
            <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
            <th>–¢–∏–ø</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–î–µ—Ç–∞–ª–∏</th>
          </tr>
        </thead>
        <tbody id="logTableBody">
          <tr>
            <td colspan="10" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="export-info">
      <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥.
      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∞–π—Ç–∞.
    </div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å—Ç—Ä–∞–Ω—ã –ø–æ –∫–æ–¥—É
    function getCountryFlag(countryCode) {
      if (!countryCode || countryCode === 'XX') return 'üåç';

      const flags = {
        'RU': 'üá∑üá∫', 'UA': 'üá∫üá¶', 'KZ': 'üá∞üáø', 'BY': 'üáßüáæ',
        'US': 'üá∫üá∏', 'GB': 'üá¨üáß', 'DE': 'üá©üá™', 'FR': 'üá´üá∑',
        'CN': 'üá®üá≥', 'JP': 'üáØüáµ', 'KR': 'üá∞üá∑', 'IN': 'üáÆüá≥',
        'BR': 'üáßüá∑', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'IT': 'üáÆüáπ',
        'ES': 'üá™üá∏', 'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥',
        'PL': 'üáµüá±', 'TR': 'üáπüá∑', 'IL': 'üáÆüá±', 'AE': 'üá¶üá™'
      };

      return flags[countryCode] || 'üåç';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats() {
      const uniqueIPs = new Set(allData.map(item => item.ip)).size;
      const totalRecords = allData.length;

      const today = new Date().toDateString();
      const todayVisits = allData.filter(item =>
        new Date(item.timestamp).toDateString() === today
      ).length;

      const uniqueCountries = new Set(allData.map(item => item.country)).size;

      // –ü–æ–¥—Å—á–µ—Ç –∫–ª–∏–∫–æ–≤
      const totalClicks = allData.filter(item => item.type === 'click').length;

      // –ü–æ–¥—Å—á–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
      const uniqueSources = new Set(allData.map(item => item.referrer || item.source || 'Unknown')).size;

      document.getElementById('uniqueIPs').textContent = uniqueIPs;
      document.getElementById('totalRecords').textContent = totalRecords;
      document.getElementById('todayVisits').textContent = todayVisits;
      document.getElementById('uniqueCountries').textContent = uniqueCountries;
      document.getElementById('totalClicks').textContent = totalClicks;
      document.getElementById('uniqueSources').textContent = uniqueSources;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç—Ä–∞–Ω
    function updateCountryFilter() {
      const countryFilter = document.getElementById('countryFilter');
      const countries = [...new Set(allData.map(item => item.country))].sort();

      // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ "–í—Å–µ"
      countryFilter.innerHTML = '<option value="">–í—Å–µ</option>';

      countries.forEach(country => {
        if (country && country !== 'Unknown') {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          countryFilter.appendChild(option);
        }
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    function updateSourceFilter() {
      const sourceFilter = document.getElementById('sourceFilter');
      const sources = [...new Set(allData.map(item => item.referrer || item.source || 'Unknown'))].sort();

      // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ "–í—Å–µ"
      sourceFilter.innerHTML = '<option value="">–í—Å–µ</option>';

      sources.forEach(source => {
        if (source && source !== 'Unknown') {
          const option = document.createElement('option');
          option.value = source;
          option.textContent = source;
          sourceFilter.appendChild(option);
        }
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData() {
      try {
        const analyticsData = JSON.parse(localStorage.getItem('gameAnalytics') || '[]');

        allData = analyticsData.map(item => ({
          ...item,
          ip: item.ip || 'Unknown',
          country: item.country || 'Unknown',
          countryCode: item.countryCode || 'XX',
          city: item.city || 'Unknown',
          deviceType: item.deviceType || 'Unknown',
          browser: item.browser || 'Unknown',
          timestamp: item.timestamp || new Date().toISOString(),
          type: item.type || 'unknown',
          action: item.action || item.eventType || 'visit',
          details: item.details || item.action || '',
          source: item.referrer || item.source || 'Unknown'
        }));

        updateStats();
        updateCountryFilter();
        updateSourceFilter();
        filterTable();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        document.getElementById('logTableBody').innerHTML =
          '<tr><td colspan="10" class="no-data">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
      }
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
    function filterTable() {
      const countryFilter = document.getElementById('countryFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const deviceFilter = document.getElementById('deviceFilter').value;
      const uniqueFilter = document.getElementById('uniqueFilter').value;
      const sourceFilter = document.getElementById('sourceFilter').value;

      // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö IP –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ IP —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
      const ipCounts = {};
      allData.forEach(item => {
        if (item.ip && item.ip !== 'Unknown') {
          ipCounts[item.ip] = (ipCounts[item.ip] || 0) + 1;
        }
      });

      filteredData = allData.filter(item => {
        const countryMatch = !countryFilter || item.country === countryFilter;
        const typeMatch = !typeFilter || item.type === typeFilter;
        const deviceMatch = !deviceFilter || item.deviceType === deviceFilter;
        const sourceMatch = !sourceFilter || item.source === sourceFilter;

        let uniqueMatch = true;
        if (uniqueFilter === 'unique') {
          uniqueMatch = ipCounts[item.ip] === 1;
        } else if (uniqueFilter === 'repeat') {
          uniqueMatch = ipCounts[item.ip] > 1;
        }

        return countryMatch && typeMatch && deviceMatch && sourceMatch && uniqueMatch;
      });

      renderTable();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    function renderTable() {
      const tbody = document.getElementById('logTableBody');

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
        return;
      }

      const rows = filteredData
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .map(item => {
          const date = new Date(item.timestamp);
          const timeStr = date.toLocaleString('ru-RU');
          const flag = getCountryFlag(item.countryCode);

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è
          let details = item.details || '';
          try {
            const parsedDetails = JSON.parse(details);
            if (typeof parsedDetails === 'object') {
              if (parsedDetails.elementText) {
                details = parsedDetails.elementText;
              } else if (parsedDetails.isUniqueVisitor !== undefined) {
                details = parsedDetails.isUniqueVisitor ? '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–∏–∑–∏—Ç' : `–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–∏–∑–∏—Ç (${parsedDetails.totalVisitsFromThisIP})`;
              } else {
                details = Object.entries(parsedDetails).map(([k, v]) => `${k}: ${v}`).join(', ');
              }
            }
          } catch (e) {
            // –ï—Å–ª–∏ –Ω–µ JSON, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
          }

          // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ –∫–ª–∞—Å—Å
          const source = item.referrer || item.source || 'Unknown';
          let sourceClass = 'source-unknown';

          if (source === '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥') {
            sourceClass = 'source-direct';
          } else if (source.includes('Google') || source.includes('Yandex') || source.includes('Bing')) {
            sourceClass = 'source-search';
          } else if (source.includes('Facebook') || source.includes('VKontakte') || source.includes('Telegram') || source.includes('Instagram') || source.includes('YouTube') || source.includes('Twitter') || source.includes('TikTok')) {
            sourceClass = 'source-social';
          }

          return `
                        <tr>
                            <td class="ip-cell">${item.ip}</td>
                            <td class="country-cell">
                                <span class="country-flag">${flag}</span>
                                ${item.country}
                            </td>
                            <td>${item.city}</td>
                            <td class="time-cell">${timeStr}</td>
                            <td class="device-${item.deviceType.toLowerCase()}">${item.deviceType}</td>
                            <td>${item.browser}</td>
                            <td class="source-cell ${sourceClass}">${source}</td>
                            <td><span class="action-cell action-${item.type}">${item.type}</span></td>
                            <td>${item.action}</td>
                            <td>${details}</td>
                        </tr>
                    `;
        }).join('');

      tbody.innerHTML = rows;
    }

    // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
    function clearLogs() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        localStorage.removeItem('gameAnalytics');
        localStorage.removeItem('gameDailyCounter');
        allData = [];
        filteredData = [];
        updateStats();
        renderTable();
        updateCountryFilter();
        alert('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã!');
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    function downloadCSV() {
      if (filteredData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }

      const headers = ['IP', '–°—Ç—Ä–∞–Ω–∞', '–ì–æ—Ä–æ–¥', '–í—Ä–µ–º—è', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', '–ë—Ä–∞—É–∑–µ—Ä', '–ò—Å—Ç–æ—á–Ω–∏–∫', '–¢–∏–ø', '–î–µ–π—Å—Ç–≤–∏–µ', '–î–µ—Ç–∞–ª–∏'];
      const csvContent = [
        headers.join(','),
        ...filteredData.map(item => [
          item.ip,
          item.country,
          item.city,
          new Date(item.timestamp).toLocaleString('ru-RU'),
          item.deviceType,
          item.browser,
          item.source,
          item.type,
          item.action,
          item.details
        ].map(field => `"${field}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `aviamasters-analytics-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
    function downloadJSON() {
      if (allData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }

      const exportData = {
        exportDate: new Date().toISOString(),
        totalRecords: allData.length,
        data: allData
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `aviamasters-analytics-${new Date().toISOString().split('T')[0]}.json`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function refreshData() {
      loadData();
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadData, 30000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>

</html>